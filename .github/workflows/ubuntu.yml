# Main doc: https://docs.github.com/en/free-pro-team@latest/actions/learn-github-actions/introduction-to-github-actions
# Runners spec: https://docs.github.com/en/free-pro-team@latest/actions/reference/specifications-for-github-hosted-runners
# Glob expressions: https://github.com/actions/toolkit/tree/main/packages/glob

name: Ubuntu

###############################################################################
# Schedule:
# - push on any branch whose name matches v** or master
# - any pull request
###############################################################################
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '**'
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      platform:
        description: 'Arguments for the platform script:'
        required: true
        default: '-extent=x -parallel=p -jobs=2 -large=i -compcert=y -unimath=n -set-switch=y'

###############################################################################
# Platform script options shared among all jobs
###############################################################################
env:
  PLATFORM: -extent=x -parallel=p -jobs=2 -large=i -compcert=y -unimath=n -set-switch=y
  COQREGTESTING: y


###############################################################################
# Ubuntu
#
# CAVEATS:
# - you need bubblewrap or the script fails
# - build-essential pulls in the C toolchain
###############################################################################
jobs:
  Ubuntu_platform:
    name: Ubuntu
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        variant:
          # This should contain all picks introduced in the current release + all original picks of all Coq versions
          - '9.0~2025.08'
          - '8.20~2025.01'
          - '8.19~2024.10'
          - '8.18~2023.11'
          - '8.17~2023.08'
          - '8.16~2022.09'
          - '8.15~2022.04'
          - '8.14~2022.01'
          - '8.13~2021.02'
          - '8.12'

    steps:
      - name: Git checkout
        uses: actions/checkout@v4
      
      - name: Initial disk usage
        run: |
          echo "=== Initial df -h ==="
          df -h
          echo
          echo "=== Initial df -i (inodes) ==="
          df -i

      - name: Disk usage diagnostics (before build)
        run: |
          echo "=== df -h ==="
          df -h

          echo "=== df -i (inodes) ==="
          df -i

          echo "=== du -sh top-level directories ==="
          for d in /home/runner/* /usr/* /opt/*; do
            if [ -d "$d" ]; then
              du -sh "$d" || true
            fi
          done

          echo "=== Directory structure (3 levels deep) for big folders ==="
          for d in /home/runner /usr /opt; do
            echo "--- $d ---"
            find "$d" -maxdepth 3 -type d | head -n 200
            echo
          done
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      - name: Disk usage diagnostics (after clean-up)
        run: |
          echo "=== df -h ==="
          df -h

          echo "=== df -i (inodes) ==="
          df -i

          echo "=== du -sh top-level directories ==="
          for d in /home/runner/* /usr/* /opt/*; do
            if [ -d "$d" ]; then
              du -sh "$d" || true
            fi
          done

          echo "=== Directory structure (3 levels deep) for big folders ==="
          for d in /home/runner /usr /opt; do
            echo "--- $d ---"
            find "$d" -maxdepth 3 -type d | head -n 200
            echo
          done
      - name: Set PLATFORM
        if: ${{ github.event.inputs.platform != '' }}
        run: echo "PLATFORM=${{ github.event.inputs.platform }}" >> $GITHUB_ENV

      - name: Install bubblewrap and build-essential
        run: |
          sudo apt-get update
          sudo apt-get install bubblewrap build-essential
          echo "=== Disk after apt install ==="
          df -h
        
      - name: Free additional disk space
        run: |
          echo "=== Disk before cleanup ==="
          df -h
          rm -rf ~/.cache/pip ~/.npm ~/.cache/npm || true
          if command -v docker >/dev/null 2>&1; then
            docker system prune -af || true
          fi
          echo "=== Disk after cleanup ==="
          df -h
          echo
          echo "=== Top 15 biggest directories in ~ ==="
          du -xhd1 ~ 2>/dev/null | sort -hr | head -n 15 || true
          
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: true
          swap-storage: true

      - name: Disk usage before platform script
        run: |
          echo "=== Disk before coq_platform_make.sh ==="
          df -h
          df -i

      - name: Run common platform script
        shell: bash
        run: ./coq_platform_make.sh  -packages=${{matrix.variant}} $PLATFORM -dumplogs

      - name: Disk usage after platform script
        if: always()
        run: |
          echo "=== Disk after coq_platform_make.sh ==="
          df -h
          df -i
          echo
          echo "=== du -sh ~/.opam (if exists) ==="
          du -sh ~/.opam || echo "no ~/.opam directory"
          echo
          echo "=== Top 20 biggest directories in ~/.opam (if exists) ==="
          du -xhd2 ~/.opam 2>/dev/null | sort -hr | head -n 20 || true

      - name: Create smoke test kit
        shell: bash
        run: |
          eval $(opam env)
          shell_scripts/create_smoke_test_kit.sh

      - name: 'Run Linux smoke test kit'
        shell: bash
        run: |
          eval $(opam env)
          smoke-test-kit/run-smoke-test.sh

      - name: 'Upload smoke test kit'
        uses: actions/upload-artifact@v4
        with:
          name: 'Smoke Test Kit ${{matrix.variant}}'
          path: smoke-test-kit
          retention-days: 5
